
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if a user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if the user is trying to access their own data
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Users Collection
    match /users/{userId} {
      // Any authenticated user can create their own user document
      allow create: if isAuthenticated();
      // Only the owner can read or update their own document, or admins can read all
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow update: if isAuthenticated() && isOwner(userId);
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // Services Collection
    match /services/{serviceId} {
        // Anyone can read services (for browsing)
        allow read: if true;
        // Only authenticated users can create services
        allow create: if isAuthenticated();
        // Only the user who created the service can update or delete it
        allow update, delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Bookings Collection
    match /bookings/{bookingId} {
        // A user can create a booking if they are authenticated
        allow create: if isAuthenticated();
        // A user can read, update, or delete a booking if they are either the client or the provider
        allow read, update, delete: if isAuthenticated() && (isOwner(resource.data.clientId) || isOwner(resource.data.providerId));
    }

    // Categories Collection
    match /categories/{categoryId} {
        // Allow public read for all users to populate dropdowns etc.
        allow read: if true;
        // Restrict write access (typically done via a trusted server or admin SDK)
        allow write: if false; 
    }
    
    // Conversations and Messages
    match /conversations/{conversationId} {
        // Allow read/write if user is a participant
        allow read, create, update: if isAuthenticated() && request.auth.uid in resource.data.participants;
        
        match /messages/{messageId} {
            // Allow read if user is a participant of the parent conversation
            allow read: if isAuthenticated() && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants.hasAny([request.auth.uid]);
            // Allow create if user is a participant and the sender
            allow create: if isAuthenticated() && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants.hasAny([request.auth.uid]) && isOwner(request.resource.data.senderId);
        }
    }
    
    // Reviews Collection
    match /reviews/{reviewId} {
        // Allow public read
        allow read: if true;
        // Authenticated users can create reviews
        allow create: if isAuthenticated();
        // Only the review author can update/delete
        allow update, delete: if isAuthenticated() && isOwner(resource.data.clientId);
    }

    // Invoices Collection
    match /invoices/{invoiceId} {
        // Only the provider who created the invoice can access it
        allow read, create, update, delete: if isAuthenticated() && isOwner(resource.data.providerId);
    }
    
    // Quotes Collection
     match /quotes/{quoteId} {
        // Only the provider who created the quote can access it
        allow read, create, update, delete: if isAuthenticated() && isOwner(resource.data.providerId);
    }
    
    // Loyalty Rewards Collection
    match /loyaltyRewards/{rewardId} {
      // Publicly readable by all authenticated users
      allow read: if isAuthenticated();
      // Should only be written by an admin/backend process
      allow write: if false;
    }
    
    // Loyalty Transactions Subcollection
    match /users/{userId}/loyaltyTransactions/{transactionId} {
      // Only the owner of the user document can read or create transactions for themselves
      allow read, create: if isAuthenticated() && isOwner(userId);
      // Transactions should be immutable
      allow update, delete: if false;
    }
    
    // Referrals Collection
    match /referrals/{referralId} {
      // Only the referrer or the referred user can read the record
      allow read: if isAuthenticated() && (isOwner(resource.data.referrerId) || isOwner(resource.data.referredId));
      // Creating referrals is handled by a backend process or transaction, so no direct client creation
      allow create, update, delete: if false;
    }
    
    // Admin-only collections
    match /auditLogs/{logId} {
      allow read, write: if isAdmin();
    }
    
    match /broadcasts/{broadcastId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /platformSettings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Platform Collection (for global settings)
    match /platform/{document} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}
